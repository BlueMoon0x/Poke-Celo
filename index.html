<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Celo Pokeball Game</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#e11d48}
    body{font-family:Inter, system-ui, Arial; background:linear-gradient(180deg,#041124 0%, #082036 100%); color:#e6eef8; display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
    .container{width:920px;max-width:95%;background:rgba(255,255,255,0.03);padding:28px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px}
    p{margin:6px 0 18px;color:rgba(230,238,248,0.8)}
    .arena{display:flex;gap:40px;justify-content:center;padding:18px}
    .pokeball{width:140px;height:140px;border-radius:50%;position:relative;cursor:pointer;transform-origin:center center;transition:transform .18s ease, box-shadow .18s}
    .pokeball .top{position:absolute;left:0;right:0;top:0;height:50%;border-top-left-radius:999px;border-top-right-radius:999px;background:linear-gradient(180deg,#ffeb3b,#fdd835);overflow:hidden}
    .pokeball .bot{position:absolute;left:0;right:0;bottom:0;height:50%;border-bottom-left-radius:999px;border-bottom-right-radius:999px;background:linear-gradient(180deg,#fff,#f2f5f9)}
    .pokeball .mid{position:absolute;left:0;right:0;top:50%;height:6px;margin-top:-3px;background:#111;border-radius:6px}
    .pokeball .button{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:44px;height:44px;border-radius:50%;background:#eee;border:6px solid #111;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111}
    .pokeball .shine{position:absolute;left:18px;top:14px;width:36px;height:36px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,0.75),rgba(255,255,255,0.06));opacity:.85;filter:blur(0.6px)}
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-14px)}100%{transform:translateY(0)}}
    .pokeball.animated{animation:floaty 2.2s ease-in-out infinite}
    .pokeball:hover{transform:scale(1.06);box-shadow:0 14px 30px rgba(2,6,23,0.6)}
    .controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .btn{padding:10px 16px;border-radius:10px;background:linear-gradient(180deg,#111827,#0b1220);border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:#e6eef8}
    .small{font-size:13px;color:rgba(230,238,248,0.8)}
    .overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center}
    .modal{background:linear-gradient(180deg,#051427,#062A3A);padding:20px;border-radius:10px;min-width:320px;text-align:center}
    .hidden{display:none}
    @media (max-width:560px){.pokeball{width:96px;height:96px}.arena{gap:14px}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@celo/contractkit@1.9.2/lib/esm/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.12.2/dist/web3.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>CELO PokéGame</h1>
    <p>Trouvez la bonne Pokeball.</p>

    <div class="arena" id="arena">
      <div class="pokeball animated" data-index="0"><div class="top"></div><div class="bot"></div><div class="mid"></div><div class="button">GO</div><div class="shine"></div></div>
      <div class="pokeball animated" data-index="1"><div class="top"></div><div class="bot"></div><div class="mid"></div><div class="button">GO</div><div class="shine"></div></div>
      <div class="pokeball animated" data-index="2"><div class="top"></div><div class="bot"></div><div class="mid"></div><div class="button">GO</div><div class="shine"></div></div>
    </div>

    <div class="controls">
      <div class="small">Mise : <strong>1 CELO</strong></div>
      <div><button class="btn" id="newRound">Nouvelle partie</button></div>
    </div>

    <div style="margin-top:12px;color:rgba(230,238,248,0.75);font-size:13px">Statut: <span id="status">Prêt</span></div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <p id="modalText">Veuillez connecter votre wallet Celo pour payer 1 CELO et jouer.</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button class="btn" id="connectWallet">Connecter Wallet</button>
        <button class="btn" id="closeModal">Annuler</button>
      </div>
    </div>
  </div>

  <script>
    const pokes = Array.from(document.querySelectorAll('.pokeball'));
    const status = document.getElementById('status');
    const overlay = document.getElementById('overlay');
    const connectWalletBtn = document.getElementById('connectWallet');
    const closeModalBtn = document.getElementById('closeModal');
    const newRoundBtn = document.getElementById('newRound');

    const CONTRACT_ADDRESS = 'REMPLIR_CONTRACT_ADDRESS'; // <- mettre l'adresse de ton smart contract
    const ABI = [ /* ABI du smart contract PokeballGame */ ];

    let winningIndex = null;
    let locked = false;
    let web3, kit, provider, contract;

    function startNewRound(){
      winningIndex = Math.floor(Math.random()*3);
      status.textContent = 'Nouvelle partie — choisissez une pokéball';
      pokes.forEach(p=>{p.style.opacity=1;p.querySelector('.button').textContent='GO'; p.classList.remove('won','lost'); delete p.dataset._selected});
      locked=false;
    }

    function showOverlay(){overlay.style.display='flex';}
    function hideOverlay(){overlay.style.display='none';}

    pokes.forEach(poke=>{
      poke.addEventListener('click', async ()=>{
        if(locked){return}
        locked=true;
        poke.dataset._selected='true';
        showOverlay();
      });
    });

    connectWalletBtn.addEventListener('click', async ()=>{
      try{
        provider = new WalletConnectProvider.default({rpc:{42220:'https://forno.celo.org'}});
        await provider.enable();
        web3 = new Web3(provider);
        kit = new window.CeloContractKit.newKitFromWeb3(web3);
        contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);

        const accounts = await web3.eth.getAccounts();
        const user = accounts[0];
        status.textContent = `Wallet connecté: ${user.substring(0,6)}...${user.slice(-4)}`;

        const selected = pokes.find(p=>p.dataset._selected==='true');
        const idx = Number(selected.dataset.index);
        status.textContent='Transaction en cours...';

        const response = await fetch(`/reveal?player=${user}&round=1&choice=${idx}`);
        const data = await response.json(); // {won:true/false}

        await contract.methods.play(user, data.won).send({from:user, value:Web3.utils.toWei('1','ether')});

        hideOverlay();
        revealResult(data.won);
      } catch(err){
        console.error(err);
        status.textContent='Erreur transaction ou wallet non connecté';
        locked=false;
        hideOverlay();
      }
    });

    closeModalBtn.addEventListener('click', ()=>{hideOverlay(); locked=false; pokes.forEach(p=>delete p.dataset._selected)});

    function revealResult(isWinner){
      const selected = pokes.find(p=>p.dataset._selected==='true');
      if(!selected){status.textContent='Erreur: aucune sélection';locked=false;return}
      const idx = Number(selected.dataset.index);
      pokes.forEach((p,i)=>{
        if(i===winningIndex){p.querySelector('.button').textContent='✨'; p.style.transform='scale(1.12)';}
        else{p.style.opacity=0.22;}
      });
      if(isWinner){
        status.textContent='Gagné ! Vous recevez 3 CELO via smart contract.';
        selected.classList.add('won');
      } else {
        status.textContent='Perdu — mieux vaut la prochaine fois.';
        selected.classList.add('lost');
      }
      setTimeout(()=>{locked=false; pokes.forEach(p=>delete p.dataset._selected)},1500);
    }

    newRoundBtn.addEventListener('click',()=>startNewRound());

    startNewRound();
  </script>
</body>
</html>
